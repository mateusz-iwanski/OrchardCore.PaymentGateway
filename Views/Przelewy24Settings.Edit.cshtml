@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer T
@model OrchardCore.PaymentGateway.Providers.Przelewy24.ViewModels.Przelewy24SettingsViewModel

@{
    Model.Accounts ??= new List<OrchardCore.PaymentGateway.Providers.Przelewy24.ViewModels.Przelewy24AccountViewModel>();
    if (!Model.Accounts.Any())
    {
        Model.Accounts.Add(new OrchardCore.PaymentGateway.Providers.Przelewy24.ViewModels.Przelewy24AccountViewModel
        {
            Key = "default",
            UseSandboxFallbacks = true
        });
    }
}

<div class="mb-3">
    <label asp-for="DefaultAccountKey" class="form-label">@T["Default account key"]</label>
    <input asp-for="DefaultAccountKey" class="form-control" />
    <span class="form-text text-muted">@T["Used when no account key is passed to the service."]</span>
</div>

<table class="table table-striped align-middle">
    <thead>
        <tr>
            <th>@T["Key"]</th>
            <th>@T["MerchantId"]</th>
            <th>@T["PosId"]</th>
            <th>@T["CRC"]</th>
            <th>@T["Report"]</th>
            <th>@T["Secret"]</th>
            <th>@T["BaseUrl"]</th>
            <th>@T["Sandbox"]</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="p24-accounts">
        @for (var i = 0; i < Model.Accounts.Count; i++)
        {
            <tr>
                <td><input name="Przelewy24Settings.Accounts[@i].Key" value="@Model.Accounts[i].Key" class="form-control" /></td>
                <td><input name="Przelewy24Settings.Accounts[@i].MerchantId" value="@Model.Accounts[i].MerchantId" class="form-control" type="number" /></td>
                <td><input name="Przelewy24Settings.Accounts[@i].PosId" value="@Model.Accounts[i].PosId" class="form-control" type="number" /></td>
                <td><input name="Przelewy24Settings.Accounts[@i].CrcKey" value="@Model.Accounts[i].CrcKey" class="form-control" /></td>
                <td><input name="Przelewy24Settings.Accounts[@i].ReportKey" value="@Model.Accounts[i].ReportKey" class="form-control" /></td>
                <td><input name="Przelewy24Settings.Accounts[@i].SecretId" value="@Model.Accounts[i].SecretId" class="form-control" /></td>
                <td><input name="Przelewy24Settings.Accounts[@i].BaseUrl" value="@Model.Accounts[i].BaseUrl" class="form-control" /></td>
                <td class="text-center">
                    <input name="Przelewy24Settings.Accounts[@i].UseSandboxFallbacks" type="checkbox" class="form-check-input" @(Model.Accounts[i].UseSandboxFallbacks ? "checked" : "") value="true" />
                    <input name="Przelewy24Settings.Accounts[@i].UseSandboxFallbacks" type="hidden" value="false" />
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger p24-remove-row">✕</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<button type="button" class="btn btn-primary" id="p24-add-row">@T["Add account"]</button>

<script at="Foot">
    document.addEventListener('DOMContentLoaded', function () {
        var addBtn = document.getElementById('p24-add-row');
        var tbody = document.getElementById('p24-accounts');

        if (addBtn && tbody) {
            addBtn.addEventListener('click', function () {
                var index = tbody.querySelectorAll('tr').length;
                var row = document.createElement('tr');
                row.innerHTML =
                    '<td><input name="Przelewy24Settings.Accounts[' + index + '].Key" class="form-control" /></td>' +
                    '<td><input name="Przelewy24Settings.Accounts[' + index + '].MerchantId" class="form-control" type="number" /></td>' +
                    '<td><input name="Przelewy24Settings.Accounts[' + index + '].PosId" class="form-control" type="number" /></td>' +
                    '<td><input name="Przelewy24Settings.Accounts[' + index + '].CrcKey" class="form-control" /></td>' +
                    '<td><input name="Przelewy24Settings.Accounts[' + index + '].ReportKey" class="form-control" /></td>' +
                    '<td><input name="Przelewy24Settings.Accounts[' + index + '].SecretId" class="form-control" /></td>' +
                    '<td><input name="Przelewy24Settings.Accounts[' + index + '].BaseUrl" class="form-control" /></td>' +
                    '<td class="text-center"><input name="Przelewy24Settings.Accounts[' + index + '].UseSandboxFallbacks" type="checkbox" class="form-check-input" checked value="true" /><input name="Przelewy24Settings.Accounts[' + index + '].UseSandboxFallbacks" type="hidden" value="false" /></td>' +
                    '<td><button type="button" class="btn btn-sm btn-danger p24-remove-row">✕</button></td>';
                tbody.appendChild(row);
            });

            tbody.addEventListener('click', function (e) {
                if (e.target.classList.contains('p24-remove-row')) {
                    e.target.closest('tr').remove();
                    // Reindex rows
                    var rows = tbody.querySelectorAll('tr');
                    rows.forEach(function (row, idx) {
                        row.querySelectorAll('input').forEach(function (input) {
                            var name = input.name;
                            if (name) {
                                input.name = name.replace(/Accounts\[\d+\]/, 'Accounts[' + idx + ']');
                            }
                        });
                    });
                }
            });
        }
    });
</script>
